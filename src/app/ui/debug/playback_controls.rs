use eframe::egui;
use crate::app::MyApp;

pub struct DebugPlaybackControls;

impl DebugPlaybackControls {
    #[allow(clippy::too_many_arguments)]
    pub fn show_controls_with_seek_bar_debug(
        app: &mut MyApp,
        ui: &mut egui::Ui,
        playback_state: &crate::player::PlaybackState,
        current_position: std::time::Duration,
        total_duration: Option<std::time::Duration>,
        on_previous: &mut dyn FnMut(),
        on_seek_backward: &mut dyn FnMut(),
        on_play_pause: &mut dyn FnMut(),
        on_stop: &mut dyn FnMut(),
        on_seek_forward: &mut dyn FnMut(),
        on_next: &mut dyn FnMut(),
        on_seek: &mut dyn FnMut(std::time::Duration),
        on_seek_start: &mut dyn FnMut(),
        on_seek_end: &mut dyn FnMut(),
        _auto_focus: bool,
        repeat_mode: &crate::settings::RepeatMode,
        shuffle_enabled: bool,
        on_repeat_mode_change: &mut dyn FnMut(crate::settings::RepeatMode),
        on_shuffle_change: &mut dyn FnMut(bool),
        on_add_seek_point: &mut dyn FnMut(),
        on_seek_to_point: &mut dyn FnMut(u64),
    ) {
        // ÂøÖË¶Å„Å™„Éá„Éº„Çø„ÇíÂèñÂæó
        let current_track = app.playlist_manager.get_current_track();
        let seek_points = app.get_current_track_seek_points();

        // PlaybackControlsÂÖ®‰Ωì„ÅÆÂà©Áî®ÂèØËÉΩÈ†òÂüü„ÇíÂèñÂæó
        let total_available_rect = ui.available_rect_before_wrap();

        // „Ç∑„Éº„ÇØ„Éê„Éº„ÇíÊúÄÂàù„Å´Ë°®Á§∫ÔºàÊ®™ÂπÖÂÖ®‰Ωì„Çí‰ΩøÁî®Ôºâ
        let seek_bar_height = 40.0; // Âõ∫ÂÆö„ÅÆÈ´ò„Åï
        let seek_bar_rect = egui::Rect::from_min_size(
            total_available_rect.min,
            egui::Vec2::new(total_available_rect.width(), seek_bar_height)
        );

        // „Ç∑„Éº„ÇØ„Éê„ÉºÈ†òÂüü„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊèèÁîª
        app.ui_state.debug_ui.draw_debug_rect_fixed(ui, seek_bar_rect, crate::debug_ui::ID_SEEK_BAR, "SeekBar");

        // „Ç∑„Éº„ÇØ„Éê„Éº„ÅÆÂÆüÈöõ„ÅÆÊèèÁîª
        crate::ui::PlaybackControlsUI::show_seek_bar(ui, current_position, total_duration, seek_points, on_seek, on_seek_start, on_seek_end);

        let space_height = 10.0;
        ui.add_space(space_height);

        // Â∑¶Âè≥ÂàÜÂâ≤„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíË®àÁÆó
        let controls_area_height = total_available_rect.height() - seek_bar_height - space_height;
        let controls_area_rect = egui::Rect::from_min_size(
            total_available_rect.min + egui::Vec2::new(0.0, seek_bar_height + space_height),
            egui::Vec2::new(total_available_rect.width(), controls_area_height)
        );

        // Â∑¶Âè≥ÂàÜÂâ≤„É¨„Ç§„Ç¢„Ç¶„Éà
        ui.horizontal(|ui| {
            let left_width = 380.0; // Â∑¶ÂÅ¥„ÅÆÂõ∫ÂÆöÂπÖ
            let separator_width = 40.0; // „Çª„Éë„É¨„Éº„Çø„ÉºÈÉ®ÂàÜ„ÅÆÂπÖÔºà„Çπ„Éö„Éº„Çπ + „Çª„Éë„É¨„Éº„Çø„Éº + „Çπ„Éö„Éº„ÇπÔºâ
            let right_width = controls_area_rect.width() - left_width - separator_width;

            // Â∑¶ÂÅ¥È†òÂüü„ÅÆÊ≠£Á¢∫„Å™„Çµ„Ç§„Ç∫Ë®àÁÆó
            let left_rect = egui::Rect::from_min_size(
                controls_area_rect.min,
                egui::Vec2::new(left_width, controls_area_height)
            );

            // Â∑¶ÂÅ¥È†òÂüü„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊèèÁîª
            app.ui_state.debug_ui.draw_debug_rect_fixed(ui, left_rect, crate::debug_ui::ID_LEFT_CONTROLS, "LeftControls");

            // Â∑¶ÂÅ¥: ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´„ÄÅ„Ç∑„Éº„ÇØ„Éù„Ç§„É≥„ÉàËøΩÂä†„ÄÅ„É™„Éî„Éº„Éà„Éª„Ç∑„É£„ÉÉ„Éï„É´
            ui.allocate_ui_with_layout(
                egui::Vec2::new(left_width, controls_area_height),
                egui::Layout::top_down(egui::Align::LEFT),
                |ui| {
                    Self::show_playback_buttons(ui, playback_state, on_previous, on_seek_backward, on_play_pause, on_stop, on_seek_forward, on_next);

                    ui.add_space(15.0);

                    // „Ç∑„Éº„ÇØ„Éù„Ç§„É≥„ÉàËøΩÂä†„Éú„Çø„É≥
                    if ui.button("üìç ÁèæÂú®‰ΩçÁΩÆ„Å´„Ç∑„Éº„ÇØ„Éù„Ç§„É≥„Éà„ÇíËøΩÂä†").clicked() {
                        on_add_seek_point();
                    }

                    ui.add_space(15.0);

                    Self::show_repeat_shuffle_controls(ui, repeat_mode, shuffle_enabled, on_repeat_mode_change, on_shuffle_change);
                }
            );

            ui.add_space(20.0);
            ui.separator();
            ui.add_space(10.0);

            // Âè≥ÂÅ¥È†òÂüü„ÅÆÊ≠£Á¢∫„Å™„Çµ„Ç§„Ç∫Ë®àÁÆó
            let right_rect = egui::Rect::from_min_size(
                controls_area_rect.min + egui::Vec2::new(left_width + separator_width, 0.0),
                egui::Vec2::new(right_width, controls_area_height)
            );

            // Âè≥ÂÅ¥È†òÂüü„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊèèÁîª
            app.ui_state.debug_ui.draw_debug_rect_fixed(ui, right_rect, crate::debug_ui::ID_RIGHT_INFO, "RightInfo");

            // Âè≥ÂÅ¥: Ê•ΩÊõ≤ÊÉÖÂ†±„Å®„Ç∑„Éº„ÇØ„Éù„Ç§„É≥„Éà‰∏ÄË¶ß
            ui.allocate_ui_with_layout(
                egui::Vec2::new(right_width, controls_area_height),
                egui::Layout::top_down(egui::Align::LEFT),
                |ui| {
                    if let Some(track) = current_track {
                        // Ê•ΩÊõ≤ÊÉÖÂ†±Ë°®Á§∫È†òÂüü„ÅÆÈñãÂßã‰ΩçÁΩÆ„ÇíË®òÈå≤
                        let track_info_start_pos = ui.next_widget_position();

                        // Ê•ΩÊõ≤ÊÉÖÂ†±„ÇíÂÆüÈöõ„Å´ÊèèÁîª
                        ui.label(egui::RichText::new(&track.title).strong());
                        ui.label(format!("{} - {}", track.artist, track.album));

                        // Ê•ΩÊõ≤ÊÉÖÂ†±Ë°®Á§∫È†òÂüü„ÅÆÁµÇ‰∫Ü‰ΩçÁΩÆ„ÇíÂèñÂæó
                        let track_info_end_pos = ui.next_widget_position();
                        let actual_track_info_height = track_info_end_pos.y - track_info_start_pos.y;

                        // Ê•ΩÊõ≤ÊÉÖÂ†±È†òÂüü„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊèèÁîªÔºàÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÅßÔºâ
                        let track_info_rect = egui::Rect::from_min_size(
                            track_info_start_pos,
                            egui::Vec2::new(right_width, actual_track_info_height)
                        );
                        app.ui_state.debug_ui.draw_debug_rect_fixed(ui, track_info_rect, crate::debug_ui::ID_TRACK_INFO, "TrackInfo");

                        // „Çπ„Éö„Éº„Çπ„ÇíËøΩÂä†
                        let space_height = 15.0;
                        ui.add_space(space_height);

                        // „Ç∑„Éº„ÇØ„Éù„Ç§„É≥„Éà‰∏ÄË¶ßÈ†òÂüü„ÅÆÈñãÂßã‰ΩçÁΩÆ
                        let seek_points_start_pos = ui.next_widget_position();

                        // ÊÆã„Çä„ÅÆÈ´ò„Åï„ÇíÊ≠£Á¢∫„Å´Ë®àÁÆó
                        let used_height = actual_track_info_height + space_height;
                        let seek_points_list_height = controls_area_height - used_height;

                        // „Ç∑„Éº„ÇØ„Éù„Ç§„É≥„Éà‰∏ÄË¶ßÈ†òÂüü„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊèèÁîªÔºàÊ≠£Á¢∫„Å™„Çµ„Ç§„Ç∫„ÅßÔºâ
                        let seek_points_rect = egui::Rect::from_min_size(
                            seek_points_start_pos,
                            egui::Vec2::new(right_width, seek_points_list_height)
                        );
                        app.ui_state.debug_ui.draw_debug_rect_fixed(ui, seek_points_rect, crate::debug_ui::ID_SEEK_POINTS_LIST, "SeekPointsList");

                        // ÊÆã„Çä„ÅÆ„Çπ„Éö„Éº„Çπ„Åß„Ç∑„Éº„ÇØ„Éù„Ç§„É≥„Éà‰∏ÄË¶ß„ÇíË°®Á§∫
                        ui.allocate_ui_with_layout(
                            egui::Vec2::new(right_width, seek_points_list_height),
                            egui::Layout::top_down(egui::Align::LEFT),
                            |ui| {
                                crate::ui::PlaybackControlsUI::show_current_track_seek_points(ui, seek_points, on_seek_to_point);
                            }
                        );
                    } else {
                        ui.label("Ê•ΩÊõ≤„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    }
                }
            );
        });
    }

    fn show_playback_buttons(
        ui: &mut egui::Ui,
        playback_state: &crate::player::PlaybackState,
        on_previous: &mut dyn FnMut(),
        on_seek_backward: &mut dyn FnMut(),
        on_play_pause: &mut dyn FnMut(),
        on_stop: &mut dyn FnMut(),
        on_seek_forward: &mut dyn FnMut(),
        on_next: &mut dyn FnMut(),
    ) {
        // ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
        ui.horizontal(|ui| {
            ui.add_space(5.0);

            let button_size = [48.0, 48.0];

            // Previous button
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new("‚èÆ").size(24.0)
                )
            ).clicked() {
                on_previous();
            }

            ui.add_space(5.0);

            // Seek backward button
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new("‚Ü©").size(24.0)
                )
            ).clicked() {
                on_seek_backward();
            }

            ui.add_space(10.0);

            // Play/pause button
            let play_pause_text = match playback_state {
                crate::player::PlaybackState::Playing => "‚è∏",
                _ => "‚ñ∂",
            };
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new(play_pause_text).size(24.0)
                )
            ).clicked() {
                on_play_pause();
            }

            ui.add_space(10.0);

            // Stop button
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new("‚èπ").size(24.0)
                )
            ).clicked() {
                on_stop();
            }

            ui.add_space(5.0);

            // Seek forward button
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new("‚Ü™").size(24.0)
                )
            ).clicked() {
                on_seek_forward();
            }

            ui.add_space(10.0);

            // Next button
            if ui.add_sized(button_size,
                egui::Button::new(
                    egui::RichText::new("‚è≠").size(24.0)
                )
            ).clicked() {
                on_next();
            }
        });
    }

    fn show_repeat_shuffle_controls(
        ui: &mut egui::Ui,
        repeat_mode: &crate::settings::RepeatMode,
        shuffle_enabled: bool,
        on_repeat_mode_change: &mut dyn FnMut(crate::settings::RepeatMode),
        on_shuffle_change: &mut dyn FnMut(bool),
    ) {
        // „É™„Éî„Éº„Éà„Éª„Ç∑„É£„ÉÉ„Éï„É´Ë®≠ÂÆö
        ui.horizontal(|ui| {
            ui.label("„É™„Éî„Éº„Éà:");
            ui.add_space(10.0);

            let repeat_text = match repeat_mode {
                crate::settings::RepeatMode::Normal => "„Ç™„Éï",
                crate::settings::RepeatMode::RepeatOne => "1Êõ≤",
                crate::settings::RepeatMode::RepeatAll => "ÂÖ®Êõ≤",
            };

            let mut new_repeat_mode = repeat_mode.clone();
            egui::ComboBox::from_id_source("repeat_selector")
                .selected_text(repeat_text)
                .show_ui(ui, |ui| {
                    if ui.selectable_value(&mut new_repeat_mode, crate::settings::RepeatMode::Normal, "„Ç™„Éï").changed() {
                        on_repeat_mode_change(crate::settings::RepeatMode::Normal);
                    }
                    if ui.selectable_value(&mut new_repeat_mode, crate::settings::RepeatMode::RepeatOne, "1Êõ≤").changed() {
                        on_repeat_mode_change(crate::settings::RepeatMode::RepeatOne);
                    }
                    if ui.selectable_value(&mut new_repeat_mode, crate::settings::RepeatMode::RepeatAll, "ÂÖ®Êõ≤").changed() {
                        on_repeat_mode_change(crate::settings::RepeatMode::RepeatAll);
                    }
                });
        });

        ui.horizontal(|ui| {
            ui.label("„Ç∑„É£„ÉÉ„Éï„É´:");
            ui.add_space(10.0);

            let shuffle_text = if shuffle_enabled { "„Ç™„É≥" } else { "„Ç™„Éï" };
            let mut new_shuffle_enabled = shuffle_enabled;
            egui::ComboBox::from_id_source("shuffle_selector")
                .selected_text(shuffle_text)
                .show_ui(ui, |ui| {
                    if ui.selectable_value(&mut new_shuffle_enabled, false, "„Ç™„Éï").changed() {
                        on_shuffle_change(false);
                    }
                    if ui.selectable_value(&mut new_shuffle_enabled, true, "„Ç™„É≥").changed() {
                        on_shuffle_change(true);
                    }
                });
        });
    }
}